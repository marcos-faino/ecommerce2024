{% extends 'base.html' %}
{% load static %}

{% block conteudo %}
<article data-theme="dark">
    <h2>Pagamento com cartão</h2>
    <form id="payment" method="post">
        <label for="card-number">Número do Cartão</label>
        <div id="card-number" class="field"></div>

        <label for="cvv">CVV</label>
        <div id="cvv" class="field"></div>

        <label for="expiration-date">Data Expiração</label>
        <div id="expiration-date" class="field"></div>
        <input type="hidden" id="nonce"
               name="payment_method_nonce" value="">
        {% csrf_token %}
        <input type="submit" value="Pagar" disabled/>
    </form>

</article>
{% endblock %}

{% block scripts %}
<script src="https://js.braintreegateway.com/web/3.44.2/js/client.min.js"></script>
<script src="https://js.braintreegateway.com/web/3.44.2/js/hosted-fields.min.js"></script>
<script>
  var form = document.querySelector('#payment');
  var submit = document.querySelector('input[type="submit"]');

  braintree.client.create({
    // Insert your tokenization key here
    authorization: '{{ braintree_client_token }}'
  }, function (clientErr, clientInstance) {
    if (clientErr) {
      console.error(clientErr);
      return;
    }

    // Create a hostedFields component to initialize the form

    braintree.hostedFields.create({
      client: clientInstance,
      // Customize the Hosted Fields.
      // More information can be found at:
      // /braintree/docs/guides/hosted-fields/styling/javascript/v3
      styles: {
        'input': {
          'font-size': '1.5em'
        },
        'input.invalid': {
          'color': 'red'
        },
        'input.valid': {
          'color': 'green'
        }
      },
      // Configure which fields in your card form will be generated by Hosted Fields instead
      fields: {
        number: {
          selector: '#card-number',             // Aqui mudei o nome para selector
          placeholder: '4111 1111 1111 1111'
        },
        cvv: {
          selector: '#cvv',              // Aqui mudei o nome para selector
          placeholder: '123'
        },
        expirationDate: {
          selector: '#expiration-date',             // Aqui mudei o nome para selector
          placeholder: '10/2022'
        }
      }
    }, function (hostedFieldsErr, instance){
      if (hostedFieldsErr) {
        console.error(hostedFieldsErr);
        return;
      }

      // Once the fields are initialized enable the submit button
      submit.removeAttribute('disabled');

      // Initialize the form submit event
      form.addEventListener('submit', function (event) {
        event.preventDefault();

        // Na linha abaixo mudei o nome da instancia para bater com o nome que havia sido dado anteriormente na linha 74
        instance.tokenize(function(tokenizeErr,payload){
            if(tokenizeErr){
                console.error(tokenizeErr);
                return;
            }
            document.getElementById('nonce').value = payload.nonce;
            form.submit();
        });
      }, false);
    });
  });
</script>
{% endblock %}